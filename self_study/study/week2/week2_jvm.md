# ðŸ“š JVM íŒŒí—¤ì¹˜ê¸°

7.16 ì˜¤ì „ ìˆ˜ì—…ìœ¼ë¡œ jvmì— ëŒ€í•´ì„œ í•™ìŠµí–ˆë‹¤. 
ì§§ì€ ì‹œê°„ ë™ì•ˆ ì¡°ì‚¬ë¥¼ ë¹ ë¥´ê²Œ í•˜ê³  íŒ€ì›ë“¤ë¼ë¦¬ ì„œë¡œ ì„¤ëª…í•´ê°€ëŠ” ë°©ì‹ìœ¼ë¡œ ê³µë¶€ë¥¼ ì§„í–‰í–ˆê³ ,
í•™ìŠµí•œ ë‚´ìš©ì„ ì •ë¦¬í•˜ë ¤ê³  í•œë‹¤. ì¶”ê°€ì ìœ¼ë¡œ í•™ìŠµí•œ ë‚´ìš©ë„ ê°™ì´ ì ì–´ë³´ë ¤ê³  í•œë‹¤. 

## JDK vs JRE vs JVM
javaë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•œ ë„êµ¬ë“¤ì˜ ëª¨ìŒì´ë¼ëŠ” ì ì—ì„œ ë™ì¼í•˜ì§€ë§Œ ë„êµ¬ë“¤ì˜ í¬í•¨ ë²”ìœ„ì— ë”°ë¼ ë‚˜ë‰œë‹¤.
ë„ì‹ë„ë¡œ í‘œí˜„í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì¡°ë¥¼ ê°€ì§„ë‹¤. 
```text
+-------------------------------------------------------------+
|                            JDK                              |
|  +---------------------------------+  +-------------------+ |
|  |              JRE                |  | Java Development  | |
|  |                                 |  |      Tools        | |
|  |  +--------+   +---------------+ |  |-------------------| |
|  |  |  JVM   |   | Java Class    | |  | javac             | |
|  |  |        |   | Library       | |  | java              | |
|  |  +--------+   +---------------+ |  | javap             | |
|  |                                 |  | apt               | |
|  +---------------------------------+  | jar               | |
|                                       | jdb               | |
|                                       | javadoc           | |
|                                       | ...               | |
|                                       +-------------------+ |
+-------------------------------------------------------------+
```
- JDK 
  - Java Development Kitì˜ ì•½ìžë¡œ, ìžë°” íŒŒì¼ì„ ì‹¤í–‰í•˜ê¸° ìœ„í•œ ëª¨ë“  íˆ´ë“¤ì´ ëª¨ì—¬ìžˆëŠ” íŒ¨í‚¤ì§€ì´ë‹¤.
  - jreì´ í¬í•¨ëœë‹¤. 
  - javac : ë°”ì´íŠ¸ ì½”ë“œ ë³€í™˜ê¸°, ìžë°” ì»´íŒŒì¼ëŸ¬
  - ë“±
- JRE
  - Java Runtime Environmentì˜ ì•½ìžë¡œ, ìžë°” ë¼ì´ë¸ŒëŸ¬ë¦¬ì™€ jvmì„ í¬í•¨í•œë‹¤.
- JVM
  - Java Virtual Machineì˜ ì•½ìžë¡œ, ì‹¤ì§ˆì ìœ¼ë¡œ ìžë°” ë°”ì´íŠ¸ ì½”ë“œê°€ ì‹¤í–‰ë˜ëŠ” í™˜ê²½ì´ë‹¤. 
  - ë‚´ë¶€ì ìœ¼ë¡œ í¬ê²Œ class loader, runtime data area, execution engine ìœ¼ë¡œ ë‚˜ë‰œë‹¤. 

## JVMì— ëŒ€í•´ì„œ 
```text
HotSpot JVM: Architecture

           +-------------------------------+
Class Files|      Class Loader Subsystem   |
---------->|   (í´ëž˜ìŠ¤ ë¡œë”© ì„œë¸Œì‹œìŠ¤í…œ)    |
           +-------------------------------+
                          |
                          v
   +-------------------------------------------------------------+
   |                       Runtime Data Areas                    |
   |  +-------------+  +------+  +-------------+  +-------------+  +------------------------+ |
   |  | Method Area |  | Heap |  | Java Threads|  | Program Counter |  | Native Internal Threads | |
   |  +-------------+  +------+  |             |  |   Registers    |  +------------------------+ |
   +-------------------+--------+--------------+-------------------+----------------------------+
                          |
                          v
   +-------------------------------------------------------------+
   |                    Execution Engine                         |
   | +-------------+ +--------------+ +-----------------------+  |
   | | Execution   | | JIT Compiler | |   Garbage Collector   |  |
   | |   Engine    | +--------------+ +-----------------------+  |
   +-------------+------------------------------------------------+
                          ^
                          |
        +-----------------+------------------+
        |                                   |
        |     +-------------------------+    |
        +---> | Native Method Interface | <---+
              +-------------------------+
                        ^
                        |
          Native Method Libraries
```

- Class Loader 
  - ì»´íŒŒì¼ëœ ìžë°” ì½”ë“œ(ë°”ì´íŠ¸ ì½”ë“œ .class í™•ìž¥ìž)ë¥¼ jvm ë©”ëª¨ë¦¬ ì˜ì—­ì— ì˜¬ë¦¬ëŠ” ì—­í• ì„ í•œë‹¤. 
- Runtime Data Area
  - jvmì˜ ë©”ëª¨ë¦¬ ì˜ì—­ìœ¼ë¡œ, pcì˜ main memoryë¥¼ ë‹´ë‹¹í•œë‹¤. 
  - method, heap, stack, pc register ë“±ìœ¼ë¡œ ë‚˜ë‰œë‹¤. 
- Execution Engine
  - ì‹¤ì§ˆì ìœ¼ë¡œ ìžë°” ë°”ì´íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰í•œë‹¤. 
  - ê¸°ë³¸ì ìœ¼ë¡œ ì¸í„°í”„ë¦¬í„° ë°©ì‹ìœ¼ë¡œ ë™ìž‘í•˜ì§€ë§Œ, ìµœì í™”ë¥¼ ìœ„í•´ JIT ì»´íŒŒì¼ëŸ¬ë¥¼ ì‚¬ìš©í•˜ê¸°ë„ í•œë‹¤. 
  - JIT : Just-in-timeì˜ ì•½ìžë¡œ, ë°˜ë³µí•´ì„œ ë“±ìž¥í•˜ëŠ” ì½”ë“œë‚˜ ìµœì í™”ê°€ ê°€ëŠ¥í•œ ë¶€ë¶„ë“¤ì„ ì»´íŒŒì¼ í•´ë‘ì–´ì„œ ì‹¤í–‰ì‹œê°„ì„ ì¤„ì´ëŠ” ì—­í• ì„ í•œë‹¤.
  - GC : ê°€ë¹„ì§€ ì»¬ë ‰í„°ì˜ ì•½ìžë¡œ, ëŸ°íƒ€ìž„ ì‹œì— ì£¼ê¸°ì ìœ¼ë¡œ heap, method ì˜ì—­ì„ íƒìƒ‰í•˜ê³  ë”ì´ìƒ ì“°ì´ì§€ ì•ŠëŠ” ê°ì²´ì— ëŒ€í•´ì„œ ë©”ëª¨ë¦¬ë¥¼ free í•œë‹¤. 

## Hello World ì‹¤í–‰ íë¦„
1. ê°œë°œìžê°€ Hello Worldë¥¼ ì¶œë ¥í•˜ëŠ” ìžë°” ì½”ë“œë¥¼ ì§ ë‹¤. (.java íŒŒì¼)
2. ìžë°” ì»´íŒŒì¼ëŸ¬ (javac)ê°€ .java í™•ìž¥ìžì˜ íŒŒì¼ì„ ì»´íŒŒì¼ í•´ì„œ ë°”ì´íŠ¸ ì½”ë“œ (.class í™•ìž¥ìž)ë¥¼ ìƒì„±í•œë‹¤. 
3. Class Loaderê°€ í•´ë‹¹ ë°”ì´íŠ¸ ì½”ë“œë¥¼ runtime data areaì— ì ìž¬í•œë‹¤. 
4. Execution Engineì´ ë©”ëª¨ë¦¬ì— ì ìž¬ëœ ë°”ì´íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰í•œë‹¤. 

## ëŸ°íƒ€ìž„ ë©”ëª¨ë¦¬ ì˜ì—­
jvmì˜ ë©”ëª¨ë¦¬ ì˜ì—­ì€ ë©´ì ‘ ë‹¨ê³¨ ì§ˆë¬¸ì´ë‹¤. ì•Œì•„ë‘ë„ë¡ í•˜ìž. 
1. method ì˜ì—­
   - classì—ì„œ í•œ ë²ˆë§Œ ìƒì„±ë˜ëŠ” ë¶€ë¶„ì´ ì €ìž¥ëœë‹¤. (method, static ë³€ìˆ˜/ë©”ì†Œë“œ, í´ëž˜ìŠ¤ ë©”íƒ€ë°ì´í„°)
   - ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì°¸ì¡°ê°€ëŠ¥í•˜ë‹¤. 
2. heap ì˜ì—­
   - classì˜ ê°ì²´ë“¤ì´ ìƒì„±ë˜ëŠ” ê³³ì´ë‹¤. 
   - ëª¨ë“  ìŠ¤ë ˆë“œê°€ ì°¸ì¡°ê°€ëŠ¥í•˜ë‹¤. 
   - GCì˜ ëŒ€ìƒì´ë‹¤. 
   - java 8 ì´í›„ë¶€í„° ì»¨ìŠ¤í„´íŠ¸ í’€ë„ heapì— ìœ„ì¹˜í•œë‹¤. (= ì»¨ìŠ¤í„´íŠ¸ í’€ë„ GCì˜ ëŒ€ìƒì´ ë˜ì—ˆë‹¤.)
3. stack ì˜ì—­
   - ìŠ¤ë ˆë“œ ë³„ë¡œ ì˜ì—­ì„ í• ë‹¹ ë°›ëŠ”ë‹¤. 
   - ë©”ì†Œë“œê°€ í˜¸ì¶œë  ë•Œë§ˆë‹¤ stack frameì´ ì„ ìž…í›„ì¶œì˜ êµ¬ì¡°ë¡œ ìŒ“ì¸ë‹¤.
     - stack frameì—ëŠ” íŒŒë¼ë¯¸í„°, ë¡œì»¬ ë³€ìˆ˜, ë¦¬í„´ ê°’ ë“±ì´ ë“¤ì–´ê°„ë‹¤.
   - ìŠ¤ë ˆë“œ ì˜ì—­ ê°„ ì°¸ì¡°ëŠ” ë¶ˆê°€ëŠ¥í•˜ë‹¤.
   - ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë˜ë©´ ìŠ¤ë ˆë“œ ì˜ì—­ë„ ì—†ì–´ì§„ë‹¤. 
4. pc register
   - ê° ìŠ¤ë ˆë“œ ë³„ context switchingì´ ì¼ì–´ë‚  ë•Œ í•„ìš”í•œ pc registerë¥¼ ê°€ì§„ë‹¤.

## GCê°€ heapì„ íƒìƒ‰í•˜ëŠ” ê³¼ì •
GCì—ëŠ” heapì„ ì–´ë–»ê²Œ íƒìƒ‰í•˜ê³ , ê°ì²´ë¥¼ ì–´ë–»ê²Œ freeí•  ê²ƒì¸ì§€ ì„±ê²©, ì—­í• ì— ë”°ë¼ ì¢…ë¥˜ê°€ ë‚˜ë‰œë‹¤. 
ì¼ë‹¨ ê¸°ë³¸ì ì¸ GCì˜ ë™ìž‘ì„ ë³´ìž. 

heapì€ í¬ê²Œ 2ê°€ì§€ ì˜ì—­ìœ¼ë¡œ ë‚˜ë‰œë‹¤. young-generation, old-generation

ê°ì²´ê°€ ì²˜ìŒ ìƒì„±ë˜ë©´ young-generation ê³µê°„ì— í• ë‹¹ëœë‹¤. 
young-generationì´ ê°€ë“ ì°¨ê±°ë‚˜, GCì˜ ì£¼ê¸°ê°€ ë˜ì—ˆì„ ë•Œ GCëŠ” heap ì˜ì—­ì„ ìˆœíšŒí•˜ë©° ì°¸ì¡°ë˜ì§€ ì•ŠëŠ” ê°ì²´ê°€ ìžˆëŠ”ì§€ íƒìƒ‰í•œë‹¤. 
ìžˆë‹¤ë©´ í•´ë‹¹ ë©”ëª¨ë¦¬ ê³µê°„ì„ free ì‹œì¼œì£¼ê³ , ì—†ë‹¤ë©´ ë‚´ë²„ë ¤ë‘”ë‹¤. 

ë§Œì•½ GCì˜ ê²€ì‚¬(?)ë¡œë¶€í„° ì‚´ì•„ë‚¨ì€ ê°ì²´ëŠ” ì˜¤ëž˜ ì‚´ì•„ë‚¨ì„ìˆ˜ë¡ old-generation ê³µê°„ìœ¼ë¡œ ì´ë™ëœë‹¤. 
ì˜¤ëž˜ ì‚´ì•„ë‚¨ì•˜ë‹¤ëŠ” ê²ƒì€ ì•žìœ¼ë¡œë„ ì˜¤ëž˜ ì°¸ì¡°ë  ê²ƒì´ë¼ê³  íŒë‹¨í•˜ê³  GCì˜ ê´€ë¦¬ ëŒ€ìƒì—ì„œ ìš°ì„ ìˆœìœ„ë¥¼ ì ê²Œ ì£¼ëŠ” ê²ƒì´ë‹¤. 

- mark
  - ì ‘ê·¼ ê°€ëŠ¥í•œ ê°ì²´ì— ëŒ€í•´ì„œ í‘œì‹œë¥¼ í•´ë‘ëŠ” ê²ƒ
- sweep
  - mark ë˜ì§€ ì•Šì€ ê°ì²´ì˜ ë©”ëª¨ë¦¬ ê³µê°„ì„ free ì‹œí‚¤ëŠ” ê²ƒ
- compact
  - ë©”ëª¨ë¦¬ ë‹¨íŽ¸í™”ê°€ ë°œìƒí–ˆì„ ë•Œ ê°ì²´ì˜ ë©”ëª¨ë¦¬ ì˜ì—­ì„ í•œ ìª½ìœ¼ë¡œ ì •ë¦¬í•˜ëŠ” ê²ƒ

## GCì˜ ì¢…ë¥˜ 
- Serial GC
  - GCë¥¼ ìœ„í•œ ìŠ¤ë ˆë“œê°€ í•˜ë‚˜ì´ê³ , í•´ë‹¹ ìŠ¤ë ˆë“œê°€ ë™ìž‘í•˜ëŠ” ë™ì•ˆ ë‹¤ë¥¸ ìž‘ì—…ì„ all stopì´ë‹¤. 
- Parallel GC
  - GCë¥¼ ìœ„í•œ ìŠ¤ë ˆë“œê°€ ì—¬ëŸ¬ê°œì´ê³ , GCê°€ ëŒì•„ê°€ëŠ” ë™ì•ˆ ë³‘ë ¬ì ìœ¼ë¡œ ë™ìž‘í•œë‹¤. ë‹¤ë¥¸ ìž‘ì—…ì€ all-stop
- CMS GC
  - mark í•˜ëŠ” ë‹¨ê³„ë¥¼ ì„¸ë¶„í™”í•´ì„œ stop-the-world ë˜ëŠ” ìƒí™©ì„ ì¤„ì¸ ê²ƒ
- G1 GC
  - heap ì˜ì—­ì„ ì¼ì • ë‹¨ìœ„ì˜ regionìœ¼ë¡œ ë‚˜ëˆ„ì–´ì„œ old/youngì„ ìœ ë™ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ê²ƒ
- Z GC
  - heap ì˜ì—­ì„ ìœ ë™ ë‹¨ìœ„ì˜ regionìœ¼ë¡œ ë‚˜ëˆ„ì–´ì„œ old/youngì„ ìœ ë™ì ìœ¼ë¡œ ê´€ë¦¬í•˜ëŠ” ê²ƒ

## GC ì„¤ì •í•˜ê¸° 
ìžë°”ë¥¼ ì‹¤í–‰í•  ë•Œ option ìœ¼ë¡œ GCë¥¼ ì§€ì •í•  ìˆ˜ ìžˆë‹¤. 
```text
java -jar -XX:+UseSerialGC Main.java    // Serial GC
java -jar -XX:+UseParallelGC Main.java  // Parallel GC
java -jar -XX:+UseG1GC Main.java        // G1 GC
java -jar -XX:+UseZGC Main.java         // Z GC
```